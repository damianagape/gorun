receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  filelog: # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/filelogreceiver/README.md
    include_file_name: false
    include_file_path: true
    include:
      - /var/log/pods/*/*/*.log
    exclude: # format is /var/log/pods/<namespace_name>_<pod_name>_<pod_uid>/<container_name>/<run_id>.log
      # Kubernetes namespaces
      - /var/log/pods/kube-*_*_*/*/*.log
      - /var/log/pods/gke-*_*_*/*/*.log
      # Observability namespaces
      - /var/log/pods/o11y-*_*_*/*/*.log
      # OpenTelemetry auto-instrumentation
      - /var/log/pods/*_*_*/opentelemetry-auto-instrumentation/*.log
      - /var/log/pods/*_*_*/opentelemetry-auto-instrumentation-*/*.log
    operators:
      - id: container-parser
        type: container # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/pkg/stanza/docs/operators/container.md
        max_log_size: 102400 # bytes, it's 100 KiB
    retry_on_failure:
      enabled: true

  k8s_cluster: # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/k8sclusterreceiver
    auth_type: serviceAccount
    allocatable_types_to_report:
      - cpu
      - memory
      - ephemeral-storage
      - pods

  k8sobjects: # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/k8sobjectsreceiver
    auth_type: serviceAccount
    objects:
      - group: ""
        name: events
        mode: watch
      - group: events.k8s.io
        name: events
        mode: watch

  kubeletstats: # https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/receiver/kubeletstatsreceiver
    auth_type: serviceAccount
    k8s_api_config:
      auth_type: serviceAccount
    node: "$${env:K8S_NODE_NAME}"
    endpoint: "https://$${env:K8S_NODE_NAME}:10250"
    insecure_skip_verify: true
    metric_groups:
      - node
      - pod
      - container
      - volume
    metrics: # https://www.hyperdx.io/docs/install/kubernetes
      k8s.pod.cpu_limit_utilization:
        enabled: true
      k8s.pod.cpu_request_utilization:
        enabled: true
      k8s.pod.memory_limit_utilization:
        enabled: true
      k8s.pod.memory_request_utilization:
        enabled: true
      k8s.pod.uptime:
        enabled: true
      k8s.node.uptime:
        enabled: true
      k8s.container.cpu_limit_utilization:
        enabled: true
      k8s.container.cpu_request_utilization:
        enabled: true
      k8s.container.memory_limit_utilization:
        enabled: true
      k8s.container.memory_request_utilization:
        enabled: true
      container.uptime:
        enabled: true

  prometheus: # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/receiver/prometheusreceiver/README.md
    config:
      scrape_configs:
        - job_name: opentelemetry-collector
          scrape_interval: 1m
          static_configs:
            - targets:
                - 0.0.0.0:8888

processors:
  memory_limiter: # https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/memorylimiterprocessor/README.md
    check_interval: 1s
    limit_percentage: 80
    spike_limit_percentage: 20

  filter: # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/filterprocessor/README.md
    error_mode: ignore
    traces:
      span:
        - 'URL(attributes["http.url"])["url.path"] == "/_healthy"'
        - 'URL(attributes["http.url"])["url.path"] == "/_healthz"'
        - 'URL(attributes["http.url"])["url.path"] == "/-/healthy"'
        - 'URL(attributes["http.url"])["url.path"] == "/-/healthz"'
        - 'URL(attributes["http.url"])["url.path"] == "/healthy"'
        - 'URL(attributes["http.url"])["url.path"] == "/healthz"'

  k8sattributes: # https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/main/processor/k8sattributesprocessor/README.md
    auth_type: serviceAccount
    %{~ if mode == "daemonset" }
    filter:
      node_from_env_var: K8S_NODE_NAME
    %{~ endif }
    passthrough: false
    pod_association:
      - sources:
          - from: resource_attribute
            name: k8s.pod.uid
      - sources:
          - from: resource_attribute
            name: k8s.pod.ip
      - sources:
          - from: connection
    extract:
      metadata:
        - k8s.node.name
        - k8s.namespace.name
        - k8s.pod.name
        - k8s.deployment.name
        - k8s.replicaset.name
        - k8s.statefulset.name
        - k8s.daemonset.name
        - k8s.cronjob.name
        - k8s.job.name
      labels:
        - from: pod
          key_regex: (.*)
          tag_name: $$1
      annotations:
        - from: pod
          key_regex: (.*)
          tag_name: $$1

  batch: # https://github.com/open-telemetry/opentelemetry-collector/blob/main/processor/batchprocessor/README.md
    timeout: 10s

exporters:
  otlp/clickstack:
    endpoint: "${clickstack_endpoint}"
    tls:
      insecure: true
    headers:
      Authorization: "$${env:CLICKSTACK_API_KEY}"
    compression: gzip

extensions:
  health_check:
    endpoint: 0.0.0.0:13133
    path: /

service:
  pipelines:
    %{~ if length(logs_receivers) > 0 }
    logs:
      receivers: ${jsonencode(logs_receivers)}
      processors: [memory_limiter, filter, k8sattributes, batch]
      exporters: [otlp/clickstack]
    %{~ endif }
    %{~ if length(metrics_receivers) > 0 }
    metrics:
      receivers: ${jsonencode(metrics_receivers)}
      processors: [memory_limiter, filter, k8sattributes, batch]
      exporters: [otlp/clickstack]
    %{~ endif }
    %{~ if length(traces_receivers) > 0 }
    traces:
      receivers: ${jsonencode(traces_receivers)}
      processors: [memory_limiter, filter, k8sattributes, batch]
      exporters: [otlp/clickstack]
    %{~ endif }

  extensions:
    - health_check
